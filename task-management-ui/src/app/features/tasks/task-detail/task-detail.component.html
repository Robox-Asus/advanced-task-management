<div class="py-4">
  <div *ngIf="loading" class="text-center py-5">
    <p class="text-muted fs-5">Loading task details...</p>
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger text-center py-3 my-4" role="alert">
    {{ error }}
  </div>

  <div *ngIf="task && !loading">
    <div class="card shadow-lg p-4 mb-4">
      <h1 class="card-title display-4 fw-bold text-dark mb-3">{{ task.title }}</h1>
      <p class="card-text fs-5 text-muted mb-4">{{ task.description }}</p>

      <div class="row g-3 mb-4 text-secondary">
        <div class="col-md-6"><span class="fw-semibold">Project:</span> <a [routerLink]="['/projects', task.projectId]" class="text-decoration-none text-primary">{{ task.projectName }}</a></div>
        <div class="col-md-6"><span class="fw-semibold">Assigned To:</span> {{ task.assignedToName || 'Unassigned' }}</div>
        <div class="col-md-6"><span class="fw-semibold">Status:</span>
          <span [ngClass]="{
            'text-primary': task.status === 'ToDo',
            'text-warning': task.status === 'InProgress',
            'text-success': task.status === 'Done',
            'text-danger': task.status === 'Blocked'
          }" class="fw-medium ms-1">{{ task.status }}</span>
        </div>
        <div class="col-md-6"><span class="fw-semibold">Priority:</span>
          <span [ngClass]="{
            'text-success': task.priority === 'Low',
            'text-warning': task.priority === 'Medium',
            'text-orange': task.priority === 'High',
            'text-danger': task.priority === 'Critical'
          }" class="fw-medium ms-1">{{ task.priority }}</span>
        </div>
        <div class="col-md-6"><span class="fw-semibold">Created:</span> {{ task.createdDate | date:'medium' }}</div>
        <div class="col-md-6"><span class="fw-semibold">Due Date:</span> {{ task.dueDate | date:'medium' }}</div>
      </div>

      <div class="d-flex gap-3">
        <button *ngIf="authService.hasRole(['Admin','ProjectManager']) || task.assignedToId === authService.currentUserValue?.id" routerLink="/tasks/edit/{{task.id}}" class="btn btn-warning shadow">
          Edit Task
        </button>
        <button *ngIf="authService.hasRole(['Admin','ProjectManager'])" (click)="deleteTask(task.id)" class="btn btn-danger shadow">
          Delete Task
        </button>
        <button [routerLink]="['/projects', task.projectId]" class="btn btn-secondary shadow">
          Back to Project
        </button>
      </div>
    </div>

    <!-- Comments Section -->
    <div class="card shadow-lg p-4">
      <h2 class="card-title fs-3 fw-bold text-dark mb-4">Comments</h2>

      <div *ngIf="task.comments && task.comments.length > 0" class="list-group mb-4">
        <div *ngFor="let comment of task.comments" class="list-group-item list-group-item-action py-3">
          <p class="mb-1 text-dark">{{ comment.content }}</p>
          <small class="text-muted fw-semibold">{{ comment.userName }}</small> <small class="text-muted">on {{ comment.createdDate | date:'short' }}</small>
        </div>
      </div>
      <div *ngIf="!task.comments || task.comments.length === 0" class="text-muted mb-4">
        No comments yet. Be the first to add one!
      </div>

      <h3 class="fs-4 fw-bold text-dark mb-3">Add a Comment</h3>
      <form [formGroup]="commentForm" (ngSubmit)="onAddCommentSubmit()" class="d-flex flex-column gap-3">
        <textarea
          formControlName="content"
          rows="3"
          class="form-control form-control-lg"
          placeholder="Write your comment here..."
          [class.is-invalid]="commentForm.get('content')?.invalid && commentForm.get('content')?.touched"
        ></textarea>
        <div *ngIf="commentForm.get('content')?.invalid && commentForm.get('content')?.touched" class="invalid-feedback d-block">
          Comment content is required.
        </div>
        <div *ngIf="commentError" class="alert alert-danger fs-6 mt-2">{{ commentError }}</div>
        <button type="submit" [disabled]="commentForm.invalid" class="btn btn-primary btn-lg shadow">
          Add Comment
        </button>
      </form>
    </div>
  </div>
</div>